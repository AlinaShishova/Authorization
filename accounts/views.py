from django.contrib.auth import login, authenticate  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
from django.shortcuts import render, redirect  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —à–∞–±–ª–æ–Ω–æ–≤ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
from .forms import LoginForm  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
from django.http import HttpResponse
from .models import User

from django.contrib.auth.hashers import check_password


def login_view(request):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω POST-–∑–∞–ø—Ä–æ—Å
    if request.method == 'POST':
        form = LoginForm(request.POST)  # –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É —Å –¥–∞–Ω–Ω—ã–º–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –∏–∑ POST-–∑–∞–ø—Ä–æ—Å–∞
        
        # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –≤–∞–ª–∏–¥–Ω–∞ (–ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
        if form.is_valid():
            username = form.cleaned_data['username']  # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ñ–æ—Ä–º—ã
            password = form.cleaned_data['password']  # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ —Ñ–æ—Ä–º—ã
            
            # –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏ –∏ –ø–∞—Ä–æ–ª—é
            try:
                user = User.objects.get(login=username)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                print(f"–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user}")  # üîç –û—Ç–ª–∞–¥–∫–∞
                if user.check_password(password):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
                    print("–ü–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π! ‚úÖ")  # üîç –û—Ç–ª–∞–¥–∫–∞
                    request.session['user_id'] = user.id  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏
                    return redirect('success')  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                else:
                    print("–ü–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π! ‚ùå")  # üîç –û—Ç–ª–∞–¥–∫–∞
                    form.add_error(None, '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å')
            except User.DoesNotExist:
                print("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω! ‚ùå")  # üîç –û—Ç–ª–∞–¥–∫–∞
                form.add_error(None, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω')
    else:
        form = LoginForm()  # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å GET, —Ç–æ —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —Ñ–æ—Ä–º—É

    # –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ñ–æ—Ä–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    return render(request, 'login.html', {'form': form})  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –≤ —à–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è



def success_view(request):
    return render(request, 'success.html')

def home(request):
    return HttpResponse('<h2>–ì–ª–∞–≤–Ω–∞—è</h2>')